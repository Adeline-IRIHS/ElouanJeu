local Players = game:GetService("Players")
local ProximityPromptService = game:GetService("ProximityPromptService")

-- Attendre que les managers soient pr√™ts
while not _G.DataManager do
	task.wait(0.5)
end

while not _G.BaseManager do
	task.wait(0.5)
end

local DataManager = _G.DataManager
local BaseManager = _G.BaseManager

-- Configuration
local SELL_MULTIPLIER = 0.5 -- Tu revends √† 1.5x le prix d'achat initial
local HOLD_DURATION = 2.5 -- Dur√©e pour vendre (2.5 secondes)

-- ‚úÖ FONCTION : Formater un nombre
local function formatNumber(num)
	num = tonumber(num) or 0

	if num >= 1000000 then
		return string.format("%.1fM", num / 1000000)
	elseif num >= 1000 then
		return string.format("%.1fK", num / 1000)
	else
		return tostring(math.floor(num))
	end
end

-- ‚úÖ FONCTION : Calculer le prix de vente
local function getSellPrice(brainrot)
	local basePrice = brainrot:GetAttribute("BasePrice") or 100
	local sellPrice = math.floor(basePrice * SELL_MULTIPLIER)
	return sellPrice
end

-- ‚úÖ FONCTION : Cr√©er le ProximityPrompt de vente
local function createSellPrompt(brainrot)
	-- V√©rifier s'il existe d√©j√†
	local existingPrompt = brainrot.PrimaryPart:FindFirstChild("SellPrompt")
	if existingPrompt then
		return existingPrompt
	end

	local rarity = brainrot:GetAttribute("Rarity") or "Brainrot"
	local sellPrice = getSellPrice(brainrot)

	local prompt = Instance.new("ProximityPrompt")
	prompt.Name = "SellPrompt"
	prompt.ObjectText = rarity .. " - üí∏ " .. formatNumber(sellPrice) .. " Rizz"
	prompt.ActionText = "Vendre"
	prompt.HoldDuration = HOLD_DURATION
	prompt.MaxActivationDistance = 15
	prompt.RequiresLineOfSight = false
	prompt.KeyboardKeyCode = Enum.KeyCode.E
	prompt.Style = Enum.ProximityPromptStyle.Default
	prompt.Parent = brainrot.PrimaryPart

	return prompt
end

-- ‚úÖ FONCTION : Vendre un brainrot
local function sellBrainrot(player, brainrot)
	-- V√©rifier que le joueur est bien le propri√©taire
	local owner = brainrot:GetAttribute("Owner")
	if owner ~= player.UserId then
		warn("‚ùå Ce n'est pas ton brainrot !")
		return false
	end

	-- V√©rifier que le brainrot est bien dans la base
	local atBase = brainrot:GetAttribute("AtBase")
	if not atBase then
		warn("‚ùå Le brainrot n'est pas dans ta base")
		return false
	end

	-- Calculer le prix de vente
	local sellPrice = getSellPrice(brainrot)
	local slotNumber = brainrot:GetAttribute("SlotNumber")

	print("üí∏ VENTE BRAINROT:")
	print("   Joueur:", player.Name)
	print("   Type:", brainrot:GetAttribute("Rarity"))
	print("   Slot:", slotNumber)
	print("   Prix de vente:", sellPrice)

	-- Ajouter le Rizz au joueur
	DataManager.AddRizz(player, sellPrice)

	-- Retirer le brainrot des donn√©es sauvegard√©es
	if slotNumber then
		DataManager.RemoveBrainrot(player, slotNumber)
	end

	-- Lib√©rer la platform
	local baseData = BaseManager.GetPlayerData(player)
	if baseData then
		for _, platform in pairs(baseData.Platforms) do
			if platform:GetAttribute("SlotNumber") == slotNumber then
				BaseManager.FreePlatform(platform)
				break
			end
		end
	end

	-- Supprimer le prompt
	local prompt = brainrot.PrimaryPart:FindFirstChild("SellPrompt")
	if prompt then
		prompt:Destroy()
	end

	-- D√©truire le brainrot
	brainrot:Destroy()

	print("‚úÖ Brainrot vendu pour", sellPrice, "Rizz !")
	return true
end

-- ‚úÖ FONCTION : Setup des prompts de vente pour tous les brainrots poss√©d√©s
local function setupSellPrompts()
	task.spawn(function()
		while true do
			task.wait(2) -- V√©rifier toutes les 2 secondes

			local ownedFolder = workspace:FindFirstChild("OwnedBrainrots")
			if not ownedFolder then continue end

			for _, brainrot in pairs(ownedFolder:GetChildren()) do
				if not brainrot:IsA("Model") then continue end

				local atBase = brainrot:GetAttribute("AtBase")
				if not atBase then continue end

				-- V√©rifier que le brainrot a un PrimaryPart
				if not brainrot.PrimaryPart then continue end

				-- V√©rifier s'il a d√©j√† un prompt de vente
				local existingPrompt = brainrot.PrimaryPart:FindFirstChild("SellPrompt")
				if existingPrompt then continue end

				-- Cr√©er le prompt de vente
				createSellPrompt(brainrot)
			end
		end
	end)
end

-- ‚úÖ FONCTION : √âcouter les √©v√©nements de vente
local function setupSellEvents()
	ProximityPromptService.PromptTriggered:Connect(function(prompt, player)
		if prompt.Name ~= "SellPrompt" then return end

		-- Le brainrot est le Parent du PrimaryPart qui contient le Prompt
		local primaryPart = prompt.Parent
		local brainrot = primaryPart and primaryPart.Parent

		if brainrot and brainrot:IsA("Model") then
			-- V√©rifier que c'est bien le propri√©taire
			local owner = brainrot:GetAttribute("Owner")
			if owner ~= player.UserId then
				warn("‚ö†Ô∏è", player.Name, "a essay√© de vendre un brainrot qui ne lui appartient pas")
				return
			end

			-- Vendre le brainrot
			local success = sellBrainrot(player, brainrot)

			if success then
				print("‚úÖ", player.Name, "a vendu un brainrot !")
			else
				warn("‚ùå √âchec de la vente du brainrot")
			end
		else
			warn("‚ùå Brainrot invalide")
		end
	end)
end

-- ‚úÖ D√âMARRAGE DU SYST√àME
setupSellPrompts()
setupSellEvents()

print("‚úÖ BrainrotSellSystem initialis√© !")

-- ‚úÖ API Globale
_G.BrainrotSellSystem = {
	SellBrainrot = sellBrainrot,
	GetSellPrice = getSellPrice
}
