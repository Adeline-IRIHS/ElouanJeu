-- ServerScriptService/AdminCommands
-- Syst√®me de commandes administrateur
-- Cr√©√© le 2025-11-17 par Adeline-IRIHS

local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")

-- Attendre que les managers soient pr√™ts
while not _G.DataManager do
	task.wait(0.5)
end

local DataManager = _G.DataManager

-- ‚úÖ CONFIGURATION
local COMMAND_PREFIX = "!" -- ‚úÖ Utilise "!" au lieu de "/"

-- ‚úÖ LISTE DES ADMINS (par UserId ou Username)
local ADMINS = {
	"Elouan050709",
}

-- ‚úÖ FONCTION : V√©rifier si un joueur est admin
local function isAdmin(player)
	-- V√©rifier par Username
	if table.find(ADMINS, player.Name) then
		return true
	end

	-- V√©rifier par UserId
	if table.find(ADMINS, player.UserId) then
		return true
	end

	return false
end

-- ‚úÖ FONCTION : Formater un nombre
local function formatNumber(num)
	num = tonumber(num) or 0

	if num >= 1000000 then
		return string.format("%.1fM", num / 1000000)
	elseif num >= 1000 then
		return string.format("%.1fK", num / 1000)
	else
		return tostring(math.floor(num))
	end
end

-- ‚úÖ COMMANDE : Add(AMOUNT)(PLAYER) - Ajouter du Rizz
local function commandAdd(admin, amount, targetName)
	amount = tonumber(amount)

	if not amount then
		warn("‚ùå Montant invalide:", amount)
		return false, "Montant invalide"
	end

	-- Trouver le joueur cible
	local target = nil
	for _, player in pairs(Players:GetPlayers()) do
		if player.Name:lower():find(targetName:lower()) or player.DisplayName:lower():find(targetName:lower()) then
			target = player
			break
		end
	end

	if not target then
		warn("‚ùå Joueur introuvable:", targetName)
		return false, "Joueur introuvable: " .. targetName
	end

	-- Ajouter le Rizz
	DataManager.AddRizz(target, amount)

	local message = string.format("‚úÖ %s Rizz ajout√©s √† %s", formatNumber(amount), target.Name)
	print("[ADMIN]", admin.Name, "‚Üí", message)

	return true, message
end

-- ‚úÖ COMMANDE : Spawn(RARITY) - Spawn un brainrot par raret√©
local function commandSpawn(admin, rarity)
	-- V√©rifier que le joueur a un personnage
	local character = admin and admin.Character
	if not character then
		-- Fallback : spawner au centre du monde
		local brainrotTemplatesFolder = ServerStorage:FindFirstChild("BrainrotTemplates")
		if not brainrotTemplatesFolder then
			return false, "Folder BrainrotTemplates introuvable dans ServerStorage"
		end

		local rarityFolder = brainrotTemplatesFolder:FindFirstChild(rarity)
		if not rarityFolder then
			return false, "Raret√© introuvable: " .. rarity
		end

		local template = rarityFolder:FindFirstChildWhichIsA("Model")
		if not template then
			return false, "Aucun template trouv√© pour: " .. rarity
		end

		local brainrot = template:Clone()

		-- ‚úÖ Ancrer toutes les parts du brainrot
		for _, part in pairs(brainrot:GetDescendants()) do
			if part:IsA("BasePart") then
				part.Anchored = true
			end
		end

		brainrot:MoveTo(Vector3.new(0, 10, 0))

		local brainrotFolder = workspace:FindFirstChild("BrainRot")
		if not brainrotFolder then
			brainrotFolder = Instance.new("Folder")
			brainrotFolder.Name = "BrainRot"
			brainrotFolder.Parent = workspace
		end

		brainrot.Parent = brainrotFolder

		-- ‚úÖ Message avec raret√© ET nom
		local message = string.format("‚úÖ Brainrot de raret√© %s (%s) a bien spawn", rarity, template.Name)
		print("[ADMIN] Console ‚Üí", message)

		return true, message
	end

	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if not rootPart then
		return false, "HumanoidRootPart introuvable"
	end

	-- Chercher le dossier de templates
	local brainrotTemplatesFolder = ServerStorage:FindFirstChild("BrainrotTemplates")
	if not brainrotTemplatesFolder then
		return false, "Folder BrainrotTemplates introuvable dans ServerStorage"
	end

	-- Chercher le dossier de raret√©
	local rarityFolder = brainrotTemplatesFolder:FindFirstChild(rarity)
	if not rarityFolder then
		return false, "Raret√© introuvable: " .. rarity
	end

	-- Prendre le premier template de cette raret√©
	local template = rarityFolder:FindFirstChildWhichIsA("Model")
	if not template then
		return false, "Aucun template trouv√© pour: " .. rarity
	end

	-- Cloner le brainrot
	local brainrot = template:Clone()

	-- ‚úÖ Ancrer toutes les parts du brainrot
	for _, part in pairs(brainrot:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Anchored = true
		end
	end

	-- Positionner devant le joueur
	local spawnPosition = rootPart.CFrame * CFrame.new(0, 0, -10) -- 10 studs devant

	if brainrot.PrimaryPart then
		brainrot:SetPrimaryPartCFrame(spawnPosition)
	else
		brainrot:MoveTo(spawnPosition.Position)
	end

	-- Parent dans BrainRot folder
	local brainrotFolder = workspace:FindFirstChild("BrainRot")
	if not brainrotFolder then
		brainrotFolder = Instance.new("Folder")
		brainrotFolder.Name = "BrainRot"
		brainrotFolder.Parent = workspace
	end

	brainrot.Parent = brainrotFolder

	-- ‚úÖ Message avec raret√© ET nom
	local message = string.format("‚úÖ Brainrot de raret√© %s (%s) a bien spawn", rarity, template.Name)
	print("[ADMIN]", admin.Name, "‚Üí", message)

	return true, message
end

-- ‚úÖ COMMANDE : SpawnName(NAME) - Spawn un brainrot par nom exact
local function commandSpawnName(admin, brainrotName)
	-- V√©rifier que le joueur a un personnage
	local character = admin and admin.Character
	if not character then
		-- Fallback : spawner au centre du monde
		local brainrotTemplatesFolder = ServerStorage:FindFirstChild("BrainrotTemplates")
		if not brainrotTemplatesFolder then
			return false, "Folder BrainrotTemplates introuvable dans ServerStorage"
		end

		local template = nil
		local foundRarity = nil

		for _, rarityFolder in pairs(brainrotTemplatesFolder:GetChildren()) do
			local found = rarityFolder:FindFirstChild(brainrotName)
			if found and found:IsA("Model") then
				template = found
				foundRarity = rarityFolder.Name -- ‚úÖ R√©cup√©rer la raret√©
				break
			end
		end

		if not template then
			return false, "Brainrot introuvable: " .. brainrotName
		end

		local brainrot = template:Clone()

		-- ‚úÖ Ancrer toutes les parts du brainrot
		for _, part in pairs(brainrot:GetDescendants()) do
			if part:IsA("BasePart") then
				part.Anchored = true
			end
		end

		brainrot:MoveTo(Vector3.new(0, 10, 0))

		local brainrotFolder = workspace:FindFirstChild("BrainRot")
		if not brainrotFolder then
			brainrotFolder = Instance.new("Folder")
			brainrotFolder.Name = "BrainRot"
			brainrotFolder.Parent = workspace
		end

		brainrot.Parent = brainrotFolder

		-- ‚úÖ Message avec raret√© ET nom
		local message = string.format("‚úÖ Brainrot de raret√© %s (%s) a bien spawn", foundRarity, brainrotName)
		print("[ADMIN] Console ‚Üí", message)

		return true, message
	end

	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if not rootPart then
		return false, "HumanoidRootPart introuvable"
	end

	-- Chercher le dossier de templates
	local brainrotTemplatesFolder = ServerStorage:FindFirstChild("BrainrotTemplates")
	if not brainrotTemplatesFolder then
		return false, "Folder BrainrotTemplates introuvable dans ServerStorage"
	end

	-- Chercher dans TOUS les dossiers de raret√©
	local template = nil
	local foundRarity = nil

	for _, rarityFolder in pairs(brainrotTemplatesFolder:GetChildren()) do
		local found = rarityFolder:FindFirstChild(brainrotName)
		if found and found:IsA("Model") then
			template = found
			foundRarity = rarityFolder.Name -- ‚úÖ R√©cup√©rer la raret√©
			break
		end
	end

	if not template then
		return false, "Brainrot introuvable: " .. brainrotName
	end

	-- Cloner le brainrot
	local brainrot = template:Clone()

	-- ‚úÖ Ancrer toutes les parts du brainrot
	for _, part in pairs(brainrot:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Anchored = true
		end
	end

	-- Positionner devant le joueur
	local spawnPosition = rootPart.CFrame * CFrame.new(0, 0, -10) -- 10 studs devant

	if brainrot.PrimaryPart then
		brainrot:SetPrimaryPartCFrame(spawnPosition)
	else
		brainrot:MoveTo(spawnPosition.Position)
	end

	-- Parent dans BrainRot folder
	local brainrotFolder = workspace:FindFirstChild("BrainRot")
	if not brainrotFolder then
		brainrotFolder = Instance.new("Folder")
		brainrotFolder.Name = "BrainRot"
		brainrotFolder.Parent = workspace
	end

	brainrot.Parent = brainrotFolder

	-- ‚úÖ Message avec raret√© ET nom
	local message = string.format("‚úÖ Brainrot de raret√© %s (%s) a bien spawn", foundRarity, brainrotName)
	print("[ADMIN]", admin.Name, "‚Üí", message)

	return true, message
end

-- ‚úÖ FONCTION : Parser et ex√©cuter une commande
local function executeCommand(player, message)
	-- V√©rifier que le joueur est admin
	if not isAdmin(player) then
		return
	end

	-- V√©rifier que le message commence par le pr√©fixe
	if message:sub(1, 1) ~= COMMAND_PREFIX then
		return
	end

	-- Retirer le pr√©fixe
	local command = message:sub(2)

	print("üîß [ADMIN] Commande de", player.Name, ":", command)

	-- ‚úÖ COMMANDE: Add(AMOUNT)(PLAYER)
	local amount, targetName = command:match("^Add%((%d+)%)%((.+)%)$")
	if amount and targetName then
		local success, result = commandAdd(player, amount, targetName)
		if success then
			print("‚úÖ", result)
		else
			warn("‚ùå", result)
		end
		return
	end

	-- ‚úÖ COMMANDE: Spawn(RARITY)
	local rarity = command:match("^Spawn%((.+)%)$")
	if rarity then
		local success, result = commandSpawn(player, rarity)
		if success then
			print("‚úÖ", result)
		else
			warn("‚ùå", result)
		end
		return
	end

	-- ‚úÖ COMMANDE: SpawnName(NAME)
	local brainrotName = command:match("^SpawnName%((.+)%)$")
	if brainrotName then
		local success, result = commandSpawnName(player, brainrotName)
		if success then
			print("‚úÖ", result)
		else
			warn("‚ùå", result)
		end
		return
	end

	-- Commande inconnue
	warn("‚ùå Commande inconnue:", command)
	print("üìã Commandes disponibles:")
	print("   " .. COMMAND_PREFIX .. "Add(MONTANT)(JOUEUR) - Ajouter du Rizz")
	print("   " .. COMMAND_PREFIX .. "Spawn(RARET√â) - Spawner un brainrot par raret√©")
	print("   " .. COMMAND_PREFIX .. "SpawnName(NOM) - Spawner un brainrot par nom")
end

-- ‚úÖ FONCTION : Setup d'un joueur
local function setupPlayer(player)
	player.Chatted:Connect(function(message)
		executeCommand(player, message)
	end)

	-- Message de bienvenue pour les admins
	if isAdmin(player) then
		task.wait(1)
		print("üëë [ADMIN]", player.Name, "s'est connect√© avec les privil√®ges admin")
		print("üìã Commandes disponibles:")
		print("   " .. COMMAND_PREFIX .. "Add(MONTANT)(JOUEUR)")
		print("   " .. COMMAND_PREFIX .. "Spawn(RARET√â)")
		print("   " .. COMMAND_PREFIX .. "SpawnName(NOM)")
	end
end

-- ‚úÖ √âCOUTER LES NOUVEAUX JOUEURS
Players.PlayerAdded:Connect(setupPlayer)

-- ‚úÖ CONFIGURER LES JOUEURS D√âJ√Ä PR√âSENTS (important pour Studio)
for _, player in pairs(Players:GetPlayers()) do
	setupPlayer(player)
end

-- ‚úÖ API GLOBALE pour ex√©cuter des commandes depuis la console
_G.AdminCmd = {
	Add = function(amount, playerName)
		-- Trouver le premier admin connect√©
		local admin = nil
		for _, player in pairs(Players:GetPlayers()) do
			if isAdmin(player) then
				admin = player
				break
			end
		end

		if not admin then
			warn("‚ùå Aucun admin connect√©")
			return false
		end

		local success, result = commandAdd(admin, amount, playerName)
		print(result)
		return success
	end,

	Spawn = function(rarity)
		local success, result = commandSpawn(nil, rarity)
		print(result)
		return success
	end,

	SpawnName = function(name)
		local success, result = commandSpawnName(nil, name)
		print(result)
		return success
	end
}

print("üëë Admins:", table.concat(ADMINS, ", "))
