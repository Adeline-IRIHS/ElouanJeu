-- ServerScriptService/AdminCommands
-- Syst√®me de commandes administrateur
-- Cr√©√© le 2025-11-17 par Adeline-IRIHS

local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local TweenService = game:GetService("TweenService")

-- Attendre que les managers soient pr√™ts
while not _G.DataManager do
	task.wait(0.5)
end

while not _G.BaseManager do
	task.wait(0.5)
end

local DataManager = _G.DataManager
local BaseManager = _G.BaseManager

-- ‚úÖ CONFIGURATION
local COMMAND_PREFIX = "!" -- ‚úÖ Utilise "!" au lieu de "/"
local MOVE_SPEED = 16 -- Vitesse de d√©placement (75% de la vitesse joueur)

-- ‚úÖ LISTE DES ADMINS (par UserId ou Username)
local ADMINS = {
	"Elouan050709",
	"Adeline-IRIHS",
}

-- ‚úÖ FONCTION : V√©rifier si un joueur est admin
local function isAdmin(player)
	-- V√©rifier par Username
	if table.find(ADMINS, player.Name) then
		return true
	end

	-- V√©rifier par UserId
	if table.find(ADMINS, player.UserId) then
		return true
	end

	return false
end

local function formatNumber(num)
	num = tonumber(num) or 0

	if num >= 1000000 then
		return string.format("%.1fM", num / 1000000)
	elseif num >= 1000 then
		return string.format("%.1fK", num / 1000)
	else
		return tostring(math.floor(num))
	end
end

local function moveBrainrotOnPath(brainrot)
	-- Trouver le folder Portal
	local portalFolder = workspace:FindFirstChild("Portal")
	if not portalFolder then
		warn("‚ùå Folder 'Portal' introuvable dans Workspace")
		brainrot:Destroy()
		return
	end

	local spawnPortalA = portalFolder:FindFirstChild("SpawnPortalA")
	local conveyorPath = workspace:FindFirstChild("ConveyorPath") 
	local spawnPortalB = portalFolder:FindFirstChild("SpawnPortalB")


	-- Obtenir la position du SpawnPortalA (c'est un Model)
	local startPosition
	if spawnPortalA.PrimaryPart then
		startPosition = spawnPortalA.PrimaryPart.Position
	else
		-- Fallback : prendre la premi√®re BasePart
		local firstPart = spawnPortalA:FindFirstChildWhichIsA("BasePart", true)
		if firstPart then
			startPosition = firstPart.Position
		else
			warn("‚ùå SpawnPortalA n'a pas de PrimaryPart ou BasePart")
			brainrot:Destroy()
			return
		end
	end

	local endPosition
	if spawnPortalB.PrimaryPart then
		endPosition = spawnPortalB.PrimaryPart.Position
	else
		-- Fallback : prendre la premi√®re BasePart
		local firstPart = spawnPortalB:FindFirstChildWhichIsA("BasePart", true)
		if firstPart then
			endPosition = firstPart.Position
		else
			warn("‚ùå SpawnPortalB n'a pas de PrimaryPart ou BasePart")
			brainrot:Destroy()
			return
		end
	end

	-- Cr√©er la liste des waypoints
	local waypoints = {}
	table.insert(waypoints, startPosition)

	-- Ajouter tous les waypoints dans l'ordre (WP1, WP2, WP3...) ‚úÖ CORRIG√â
	for i = 1, 100 do -- Maximum 100 waypoints
		local waypoint = conveyorPath:FindFirstChild("WP" .. i)
		if waypoint then
			table.insert(waypoints, waypoint.Position)
		else
			break
		end
	end

	table.insert(waypoints, endPosition)

	print("üó∫Ô∏è Chemin de", #waypoints, "waypoints cr√©√©")

	-- D√©placer le brainrot sur chaque waypoint
	for i, targetPos in ipairs(waypoints) do
		-- V√©rifier que le brainrot existe toujours
		if not brainrot or not brainrot.Parent or not brainrot.PrimaryPart then
			return
		end

		-- V√©rifier si le brainrot a √©t√© achet√© (attribut Owner existe)
		if brainrot:GetAttribute("Owner") then
			print("üõë Brainrot achet√©, arr√™t du d√©placement")
			return
		end

		-- Calculer la distance et le temps
		local currentPos = brainrot.PrimaryPart.Position
		local distance = (targetPos - currentPos).Magnitude
		local travelTime = distance / MOVE_SPEED

		-- Cr√©er le tween
		local tweenInfo = TweenInfo.new(
			travelTime,
			Enum.EasingStyle.Linear,
			Enum.EasingDirection.InOut
		)

		local tween = TweenService:Create(
			brainrot.PrimaryPart,
			tweenInfo,
			{CFrame = CFrame.new(targetPos)}
		)

		-- D√©placer
		tween:Play()
		tween.Completed:Wait()

		-- Si c'est le dernier waypoint (SpawnPortalB), d√©truire
		if i == #waypoints then
			print("üö™ Brainrot arriv√© au SpawnPortalB, destruction")
			brainrot:Destroy()
			return
		end
	end
end

-- ‚úÖ COMMANDE : Add(AMOUNT)(PLAYER) - Ajouter du Rizz
local function commandAdd(admin, amount, targetName)
	amount = tonumber(amount)

	if not amount then
		warn("‚ùå Montant invalide:", amount)
		return false, "Montant invalide"
	end

	-- Trouver le joueur cible
	local target = nil
	for _, player in pairs(Players:GetPlayers()) do
		if player.Name:lower():find(targetName:lower()) or player.DisplayName:lower():find(targetName:lower()) then
			target = player
			break
		end
	end

	if not target then
		warn("‚ùå Joueur introuvable:", targetName)
		return false, "Joueur introuvable: " .. targetName
	end

	-- Ajouter le Rizz
	DataManager.AddRizz(target, amount)

	local message = string.format("‚úÖ %s Rizz ajout√©s √† %s", formatNumber(amount), target.Name)
	print("[ADMIN]", admin.Name, "‚Üí", message)

	return true, message
end

-- ‚úÖ COMMANDE : Reset(PLAYER) - R√©initialiser la base et le Rizz d'un joueur
local function commandReset(admin, targetName)
	-- Trouver le joueur cible
	local target = nil
	for _, player in pairs(Players:GetPlayers()) do
		if player.Name:lower():find(targetName:lower()) or player.DisplayName:lower():find(targetName:lower()) then
			target = player
			break
		end
	end

	if not target then
		warn("‚ùå Joueur introuvable:", targetName)
		return false, "Joueur introuvable: " .. targetName
	end

	print("üîÑ R√©initialisation de", target.Name, "...")

	-- 1. D√©truire tous les brainrots du joueur
	local ownedFolder = workspace:FindFirstChild("OwnedBrainrots")
	if ownedFolder then
		for _, brainrot in pairs(ownedFolder:GetChildren()) do
			if brainrot:IsA("Model") then
				local owner = brainrot:GetAttribute("Owner")
				if owner == target.UserId then
					print("   üóëÔ∏è Suppression brainrot:", brainrot.Name)
					brainrot:Destroy()
				end
			end
		end
	end

	-- 2. Lib√©rer toutes les platforms
	local baseData = BaseManager.GetPlayerData(target)
	if baseData then
		for _, platform in pairs(baseData.Platforms) do
			BaseManager.FreePlatform(platform)
		end
		print("   ‚úÖ Platforms lib√©r√©es")
	end

	-- 3. R√©initialiser les donn√©es avec DataManager
	local resetSuccess = DataManager.ResetData(target)

	if resetSuccess then
		print("   ‚úÖ Donn√©es r√©initialis√©es")

		-- 4. Mettre √† jour les leaderstats
		local leaderstats = target:FindFirstChild("leaderstats")
		if leaderstats then
			local rizzValue = leaderstats:FindFirstChild("Rizz")
			if rizzValue then
				rizzValue.Value = 1000 -- Valeur par d√©faut
			end
			local levelValue = leaderstats:FindFirstChild("Level")
			if levelValue then
				levelValue.Value = 1
			end
		end

		local message = string.format("‚úÖ %s a √©t√© r√©initialis√© (Base + Rizz + Brainrots)", target.Name)
		print("[ADMIN]", admin.Name, "‚Üí", message)

		return true, message
	else
		warn("‚ùå √âchec de la r√©initialisation des donn√©es")
		return false, "√âchec de la r√©initialisation"
	end
end

-- ‚úÖ COMMANDE : Spawn(RARITY) - Spawn un brainrot statique
local function commandSpawn(admin, rarity)
	-- V√©rifier que le joueur a un personnage
	local character = admin and admin.Character
	if not character then
		-- Fallback : spawner au centre du monde
		local brainrotTemplatesFolder = ServerStorage:FindFirstChild("BrainrotTemplates")
		if not brainrotTemplatesFolder then
			return false, "Folder BrainrotTemplates introuvable dans ServerStorage"
		end

		local rarityFolder = brainrotTemplatesFolder:FindFirstChild(rarity)
		if not rarityFolder then
			return false, "Raret√© introuvable: " .. rarity
		end

		local template = rarityFolder:FindFirstChildWhichIsA("Model")
		if not template then
			return false, "Aucun template trouv√© pour: " .. rarity
		end

		local brainrot = template:Clone()

		-- ‚úÖ CONFIGURER LES ATTRIBUTS DU BRAINROT
		brainrot:SetAttribute("Rarity", rarity)
		brainrot:SetAttribute("BasePrice", template:GetAttribute("BasePrice") or 100)
		brainrot:SetAttribute("RizzPerTick", template:GetAttribute("RizzPerTick") or 1)
		brainrot:SetAttribute("SpawnTime", tick())
		brainrot:SetAttribute("Model.Name", template.Name)


		-- ‚úÖ Ancrer toutes les parts du brainrot
		for _, part in pairs(brainrot:GetDescendants()) do
			if part:IsA("BasePart") then
				part.Anchored = true
			end
		end

		-- ‚úÖ UTILISER PivotTo au lieu de MoveTo
		brainrot:PivotTo(CFrame.new(Vector3.new(0, 10, 0)))

		local brainrotFolder = workspace:FindFirstChild("BrainRot")
		if not brainrotFolder then
			brainrotFolder = Instance.new("Folder")
			brainrotFolder.Name = "BrainRot"
			brainrotFolder.Parent = workspace
		end

		brainrot.Parent = brainrotFolder

		-- ‚úÖ Message avec raret√© ET nom
		local message = string.format("‚úÖ Brainrot de raret√© %s (%s) a bien spawn", rarity, template.Name)
		print("[ADMIN] Console ‚Üí", message)

		return true, message
	end

	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if not rootPart then
		return false, "HumanoidRootPart introuvable"
	end

	-- Chercher le dossier de templates
	local brainrotTemplatesFolder = ServerStorage:FindFirstChild("BrainrotTemplates")
	if not brainrotTemplatesFolder then
		return false, "Folder BrainrotTemplates introuvable dans ServerStorage"
	end

	-- Chercher le dossier de raret√©
	local rarityFolder = brainrotTemplatesFolder:FindFirstChild(rarity)
	if not rarityFolder then
		return false, "Raret√© introuvable: " .. rarity
	end

	-- Prendre le premier template de cette raret√©
	local template = rarityFolder:FindFirstChildWhichIsA("Model")
	if not template then
		return false, "Aucun template trouv√© pour: " .. rarity
	end

	-- Cloner le brainrot
	local brainrot = template:Clone()

	-- ‚úÖ CONFIGURER LES ATTRIBUTS DU BRAINROT
	brainrot:SetAttribute("Rarity", rarity)
	brainrot:SetAttribute("BasePrice", template:GetAttribute("BasePrice") or 100)
	brainrot:SetAttribute("RizzPerTick", template:GetAttribute("RizzPerTick") or 1)
	brainrot:SetAttribute("SpawnTime", tick())
	brainrot:SetAttribute("Model.Name", template.Name)


	-- ‚úÖ Ancrer toutes les parts du brainrot
	for _, part in pairs(brainrot:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Anchored = true
		end
	end

	-- Positionner devant le joueur
	local spawnPosition = rootPart.CFrame * CFrame.new(0, 0, -10) -- 10 studs devant

	-- ‚úÖ UTILISER PivotTo au lieu de SetPrimaryPartCFrame
	brainrot:PivotTo(spawnPosition)

	-- Parent dans BrainRot folder
	local brainrotFolder = workspace:FindFirstChild("BrainRot")
	if not brainrotFolder then
		brainrotFolder = Instance.new("Folder")
		brainrotFolder.Name = "BrainRot"
		brainrotFolder.Parent = workspace
	end

	brainrot.Parent = brainrotFolder

	-- ‚úÖ Message avec raret√© ET nom
	local message = string.format("‚úÖ Brainrot de raret√© %s (%s) a bien spawn", rarity, template.Name)
	print("[ADMIN]", admin.Name, "‚Üí", message)

	return true, message
end

-- ‚úÖ COMMANDE : SpawnMoving(RARITY) - Spawn un brainrot qui se d√©place
local function commandSpawnMoving(admin, rarity)
	-- Chercher le dossier de templates
	local brainrotTemplatesFolder = ServerStorage:FindFirstChild("BrainrotTemplates")
	if not brainrotTemplatesFolder then
		return false, "Folder BrainrotTemplates introuvable dans ServerStorage"
	end

	-- Chercher le dossier de raret√©
	local rarityFolder = brainrotTemplatesFolder:FindFirstChild(rarity)
	if not rarityFolder then
		return false, "Raret√© introuvable: " .. rarity
	end

	-- Prendre le premier template de cette raret√©
	local template = rarityFolder:FindFirstChildWhichIsA("Model")
	if not template then
		return false, "Aucun template trouv√© pour: " .. rarity
	end

	-- Trouver le folder Portal
	local portalFolder = workspace:FindFirstChild("Portal")
	if not portalFolder then
		return false, "Folder 'Portal' introuvable dans Workspace"
	end

	-- Trouver SpawnPortalA
	local spawnPortalA = portalFolder:FindFirstChild("SpawnPortalA")
	if not spawnPortalA then
		return false, "SpawnPortalA introuvable dans Portal"
	end

	-- Obtenir la position du SpawnPortalA
	local startPosition
	if spawnPortalA.PrimaryPart then
		startPosition = spawnPortalA.PrimaryPart.Position
	else
		local firstPart = spawnPortalA:FindFirstChildWhichIsA("BasePart", true)
		if firstPart then
			startPosition = firstPart.Position
		else
			return false, "SpawnPortalA n'a pas de PrimaryPart ou BasePart"
		end
	end

	-- Cloner le brainrot
	local brainrot = template:Clone()

	-- ‚úÖ CONFIGURER LES ATTRIBUTS DU BRAINROT
	brainrot:SetAttribute("Rarity", rarity)
	brainrot:SetAttribute("BasePrice", template:GetAttribute("BasePrice") or 100)
	brainrot:SetAttribute("RizzPerTick", template:GetAttribute("RizzPerTick") or 1)
	brainrot:SetAttribute("SpawnTime", tick())
	brainrot:SetAttribute("Model.Name", template.Name)


	-- ‚úÖ D√©sancrer pour permettre le d√©placement
	for _, part in pairs(brainrot:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Anchored = false
			part.CanCollide = false
		end
	end

	-- Ancrer SEULEMENT le PrimaryPart
	if brainrot.PrimaryPart then
		brainrot.PrimaryPart.Anchored = true
	end

	-- ‚úÖ UTILISER PivotTo au lieu de SetPrimaryPartCFrame
	brainrot:PivotTo(CFrame.new(startPosition))

	-- Parent dans BrainRot folder
	local brainrotFolder = workspace:FindFirstChild("BrainRot")
	if not brainrotFolder then
		brainrotFolder = Instance.new("Folder")
		brainrotFolder.Name = "BrainRot"
		brainrotFolder.Parent = workspace
	end

	brainrot.Parent = brainrotFolder

	-- ‚úÖ Lancer le d√©placement
	task.spawn(function()
		moveBrainrotOnPath(brainrot)
	end)

	-- ‚úÖ Message avec raret√© ET nom
	local message = string.format("‚úÖ Brainrot mobile de raret√© %s (%s) spawn√© au SpawnPortalA", rarity, template.Name)
	print("[ADMIN]", admin and admin.Name or "Console", "‚Üí", message)

	return true, message
end

-- ‚úÖ COMMANDE : SpawnMovingN(NAME) - Spawn un brainrot mobile par nom
local function commandSpawnMovingN(admin, brainrotName)
	-- Chercher le dossier de templates
	local brainrotTemplatesFolder = ServerStorage:FindFirstChild("BrainrotTemplates")
	if not brainrotTemplatesFolder then
		return false, "Folder BrainrotTemplates introuvable dans ServerStorage"
	end

	-- Chercher dans TOUS les dossiers de raret√©
	local template = nil
	local foundRarity = nil

	for _, rarityFolder in pairs(brainrotTemplatesFolder:GetChildren()) do
		local found = rarityFolder:FindFirstChild(brainrotName)
		if found and found:IsA("Model") then
			template = found
			foundRarity = rarityFolder.Name -- ‚úÖ R√©cup√©rer la raret√©
			break
		end
	end

	if not template then
		return false, "Brainrot introuvable: " .. brainrotName
	end

	-- Trouver le folder Portal
	local portalFolder = workspace:FindFirstChild("Portal")
	if not portalFolder then
		return false, "Folder 'Portal' introuvable dans Workspace"
	end

	-- Trouver SpawnPortalA
	local spawnPortalA = portalFolder:FindFirstChild("SpawnPortalA")
	if not spawnPortalA then
		return false, "SpawnPortalA introuvable dans Portal"
	end

	-- Obtenir la position du SpawnPortalA
	local startPosition
	if spawnPortalA.PrimaryPart then
		startPosition = spawnPortalA.PrimaryPart.Position
	else
		local firstPart = spawnPortalA:FindFirstChildWhichIsA("BasePart", true)
		if firstPart then
			startPosition = firstPart.Position
		else
			return false, "SpawnPortalA n'a pas de PrimaryPart ou BasePart"
		end
	end

	-- Cloner le brainrot
	local brainrot = template:Clone()

	-- ‚úÖ CONFIGURER LES ATTRIBUTS DU BRAINROT
	brainrot:SetAttribute("Rarity", foundRarity)
	brainrot:SetAttribute("BasePrice", template:GetAttribute("BasePrice") or 100)
	brainrot:SetAttribute("RizzPerTick", template:GetAttribute("RizzPerTick") or 1)
	brainrot:SetAttribute("SpawnTime", tick())
	brainrot:SetAttribute("Model.Name", template.Name)


	-- ‚úÖ D√©sancrer pour permettre le d√©placement
	for _, part in pairs(brainrot:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Anchored = false
			part.CanCollide = false
		end
	end

	-- Ancrer SEULEMENT le PrimaryPart
	if brainrot.PrimaryPart then
		brainrot.PrimaryPart.Anchored = true
	end

	-- ‚úÖ UTILISER PivotTo au lieu de SetPrimaryPartCFrame
	brainrot:PivotTo(CFrame.new(startPosition))

	-- Parent dans BrainRot folder
	local brainrotFolder = workspace:FindFirstChild("BrainRot")
	if not brainrotFolder then
		brainrotFolder = Instance.new("Folder")
		brainrotFolder.Name = "BrainRot"
		brainrotFolder.Parent = workspace
	end

	brainrot.Parent = brainrotFolder

	-- ‚úÖ Lancer le d√©placement
	task.spawn(function()
		moveBrainrotOnPath(brainrot)
	end)

	-- ‚úÖ Message avec raret√© ET nom
	local message = string.format("‚úÖ Brainrot mobile de raret√© %s (%s) spawn√© au SpawnPortalA", foundRarity, brainrotName)
	print("[ADMIN]", admin and admin.Name or "Console", "‚Üí", message)

	return true, message
end

-- ‚úÖ COMMANDE : SpawnName(NAME) - Spawn un brainrot par nom exact
local function commandSpawnName(admin, brainrotName)
	-- V√©rifier que le joueur a un personnage
	local character = admin and admin.Character
	if not character then
		-- Fallback : spawner au centre du monde
		local brainrotTemplatesFolder = ServerStorage:FindFirstChild("BrainrotTemplates")
		if not brainrotTemplatesFolder then
			return false, "Folder BrainrotTemplates introuvable dans ServerStorage"
		end

		local template = nil
		local foundRarity = nil

		for _, rarityFolder in pairs(brainrotTemplatesFolder:GetChildren()) do
			local found = rarityFolder:FindFirstChild(brainrotName)
			if found and found:IsA("Model") then
				template = found
				foundRarity = rarityFolder.Name -- ‚úÖ R√©cup√©rer la raret√©
				break
			end
		end

		if not template then
			return false, "Brainrot introuvable: " .. brainrotName
		end

		local brainrot = template:Clone()

		-- ‚úÖ CONFIGURER LES ATTRIBUTS DU BRAINROT
		brainrot:SetAttribute("Rarity", foundRarity)
		brainrot:SetAttribute("BasePrice", template:GetAttribute("BasePrice") or 100)
		brainrot:SetAttribute("RizzPerTick", template:GetAttribute("RizzPerTick") or 1)
		brainrot:SetAttribute("SpawnTime", tick())

		-- ‚úÖ Ancrer toutes les parts du brainrot
		for _, part in pairs(brainrot:GetDescendants()) do
			if part:IsA("BasePart") then
				part.Anchored = true
			end
		end

		-- ‚úÖ UTILISER PivotTo au lieu de MoveTo
		brainrot:PivotTo(CFrame.new(Vector3.new(0, 10, 0)))

		local brainrotFolder = workspace:FindFirstChild("BrainRot")
		if not brainrotFolder then
			brainrotFolder = Instance.new("Folder")
			brainrotFolder.Name = "BrainRot"
			brainrotFolder.Parent = workspace
		end

		brainrot.Parent = brainrotFolder

		-- ‚úÖ Message avec raret√© ET nom
		local message = string.format("‚úÖ Brainrot de raret√© %s (%s) a bien spawn", foundRarity, brainrotName)
		print("[ADMIN] Console ‚Üí", message)

		return true, message
	end

	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if not rootPart then
		return false, "HumanoidRootPart introuvable"
	end

	-- Chercher le dossier de templates
	local brainrotTemplatesFolder = ServerStorage:FindFirstChild("BrainrotTemplates")
	if not brainrotTemplatesFolder then
		return false, "Folder BrainrotTemplates introuvable dans ServerStorage"
	end

	-- Chercher dans TOUS les dossiers de raret√©
	local template = nil
	local foundRarity = nil

	for _, rarityFolder in pairs(brainrotTemplatesFolder:GetChildren()) do
		local found = rarityFolder:FindFirstChild(brainrotName)
		if found and found:IsA("Model") then
			template = found
			foundRarity = rarityFolder.Name -- ‚úÖ R√©cup√©rer la raret√©
			break
		end
	end

	if not template then
		return false, "Brainrot introuvable: " .. brainrotName
	end

	-- Cloner le brainrot
	local brainrot = template:Clone()

	-- ‚úÖ CONFIGURER LES ATTRIBUTS DU BRAINROT
	brainrot:SetAttribute("Rarity", foundRarity)
	brainrot:SetAttribute("BasePrice", template:GetAttribute("BasePrice") or 100)
	brainrot:SetAttribute("RizzPerTick", template:GetAttribute("RizzPerTick") or 1)
	brainrot:SetAttribute("SpawnTime", tick())

	-- ‚úÖ Ancrer toutes les parts du brainrot
	for _, part in pairs(brainrot:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Anchored = true
		end
	end

	-- Positionner devant le joueur
	local spawnPosition = rootPart.CFrame * CFrame.new(0, 0, -10) -- 10 studs devant

	-- ‚úÖ UTILISER PivotTo au lieu de SetPrimaryPartCFrame
	brainrot:PivotTo(spawnPosition)

	-- Parent dans BrainRot folder
	local brainrotFolder = workspace:FindFirstChild("BrainRot")
	if not brainrotFolder then
		brainrotFolder = Instance.new("Folder")
		brainrotFolder.Name = "BrainRot"
		brainrotFolder.Parent = workspace
	end

	brainrot.Parent = brainrotFolder

	-- ‚úÖ Message avec raret√© ET nom
	local message = string.format("‚úÖ Brainrot de raret√© %s (%s) a bien spawn", foundRarity, brainrotName)
	print("[ADMIN]", admin.Name, "‚Üí", message)

	return true, message
end

-- ‚úÖ FONCTION : Parser et ex√©cuter une commande
local function executeCommand(player, message)
	-- V√©rifier que le joueur est admin
	if not isAdmin(player) then
		return
	end

	-- V√©rifier que le message commence par le pr√©fixe
	if message:sub(1, 1) ~= COMMAND_PREFIX then
		return
	end

	-- Retirer le pr√©fixe
	local command = message:sub(2)

	print("üîß [ADMIN] Commande de", player.Name, ":", command)

	-- ‚úÖ COMMANDE: Add(AMOUNT)(PLAYER)
	local amount, targetName = command:match("^Add%((%d+)%)%((.+)%)$")
	if amount and targetName then
		local success, result = commandAdd(player, amount, targetName)
		if success then
			print("‚úÖ", result)
		else
			warn("‚ùå", result)
		end
		return
	end

	-- ‚úÖ COMMANDE: Reset(PLAYER)
	local resetTarget = command:match("^Reset%((.+)%)$")
	if resetTarget then
		local success, result = commandReset(player, resetTarget)
		if success then
			print("‚úÖ", result)
		else
			warn("‚ùå", result)
		end
		return
	end

	-- ‚úÖ COMMANDE: SpawnMovingN(NAME)
	local movingName = command:match("^SpawnMovingN%((.+)%)$")
	if movingName then
		local success, result = commandSpawnMovingN(player, movingName)
		if success then
			print("‚úÖ", result)
		else
			warn("‚ùå", result)
		end
		return
	end

	-- ‚úÖ COMMANDE: SpawnMoving(RARITY)
	local movingRarity = command:match("^SpawnMoving%((.+)%)$")
	if movingRarity then
		local success, result = commandSpawnMoving(player, movingRarity)
		if success then
			print("‚úÖ", result)
		else
			warn("‚ùå", result)
		end
		return
	end

	-- ‚úÖ COMMANDE: Spawn(RARITY)
	local rarity = command:match("^Spawn%((.+)%)$")
	if rarity then
		local success, result = commandSpawn(player, rarity)
		if success then
			print("‚úÖ", result)
		else
			warn("‚ùå", result)
		end
		return
	end

	-- ‚úÖ COMMANDE: SpawnName(NAME)
	local brainrotName = command:match("^SpawnName%((.+)%)$")
	if brainrotName then
		local success, result = commandSpawnName(player, brainrotName)
		if success then
			print("‚úÖ", result)
		else
			warn("‚ùå", result)
		end
		return
	end

	-- Commande inconnue
	warn("‚ùå Commande inconnue:", command)
	print("üìã Commandes disponibles:")
	print("   " .. COMMAND_PREFIX .. "Add(MONTANT)(JOUEUR) - Ajouter du Rizz")
	print("   " .. COMMAND_PREFIX .. "Reset(JOUEUR) - R√©initialiser un joueur")
	print("   " .. COMMAND_PREFIX .. "Spawn(RARET√â) - Spawner un brainrot statique")
	print("   " .. COMMAND_PREFIX .. "SpawnMoving(RARET√â) - Spawner un brainrot mobile")
	print("   " .. COMMAND_PREFIX .. "SpawnMovingN(NOM) - Spawner un brainrot mobile par nom")
	print("   " .. COMMAND_PREFIX .. "SpawnName(NOM) - Spawner un brainrot par nom")
end

-- ‚úÖ FONCTION : Setup d'un joueur
local function setupPlayer(player)
	player.Chatted:Connect(function(message)
		executeCommand(player, message)
	end)

	-- Message de bienvenue pour les admins
	if isAdmin(player) then
		task.wait(1)
		print("üëë [ADMIN]", player.Name, "s'est connect√© avec les privil√®ges admin")
		print("üìã Commandes disponibles:")
		print("   " .. COMMAND_PREFIX .. "Add(MONTANT)(JOUEUR)")
		print("   " .. COMMAND_PREFIX .. "Reset(JOUEUR)")
		print("   " .. COMMAND_PREFIX .. "Spawn(RARET√â)")
		print("   " .. COMMAND_PREFIX .. "SpawnMoving(RARET√â)")
		print("   " .. COMMAND_PREFIX .. "SpawnMovingN(NOM)")
		print("   " .. COMMAND_PREFIX .. "SpawnName(NOM)")
	end
end

-- ‚úÖ √âCOUTER LES NOUVEAUX JOUEURS
Players.PlayerAdded:Connect(setupPlayer)

-- ‚úÖ CONFIGURER LES JOUEURS D√âJ√Ä PR√âSENTS (important pour Studio)
for _, player in pairs(Players:GetPlayers()) do
	setupPlayer(player)
end

-- ‚úÖ API GLOBALE pour ex√©cuter des commandes depuis la console
_G.AdminCmd = {
	Add = function(amount, playerName)
		-- Trouver le premier admin connect√©
		local admin = nil
		for _, player in pairs(Players:GetPlayers()) do
			if isAdmin(player) then
				admin = player
				break
			end
		end

		if not admin then
			warn("‚ùå Aucun admin connect√©")
			return false
		end

		local success, result = commandAdd(admin, amount, playerName)
		print(result)
		return success
	end,

	Reset = function(playerName)
		-- Trouver le premier admin connect√©
		local admin = nil
		for _, player in pairs(Players:GetPlayers()) do
			if isAdmin(player) then
				admin = player
				break
			end
		end

		if not admin then
			warn("‚ùå Aucun admin connect√©")
			return false
		end

		local success, result = commandReset(admin, playerName)
		print(result)
		return success
	end,

	Spawn = function(rarity)
		local success, result = commandSpawn(nil, rarity)
		print(result)
		return success
	end,

	SpawnMoving = function(rarity)
		local success, result = commandSpawnMoving(nil, rarity)
		print(result)
		return success
	end,

	SpawnMovingN = function(name)
		local success, result = commandSpawnMovingN(nil, name)
		print(result)
		return success
	end,

	SpawnName = function(name)
		local success, result = commandSpawnName(nil, name)
		print(result)
		return success
	end
}
