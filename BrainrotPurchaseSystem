-- ServerScriptService/BrainrotPurchaseSystem
-- Syst√®me d'achat avec ProximityPrompts et d√©placement vers la base
-- Cr√©√© le 2025-11-17 par Adeline-IRIHS


local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local ProximityPromptService = game:GetService("ProximityPromptService")
local RunService = game:GetService("RunService")


-- Attendre que les managers soient pr√™ts
while not _G.DataManager do
	task.wait(0.5)
end

while not _G.BaseManager do
	task.wait(0.5)
end

local DataManager = _G.DataManager
local BaseManager = _G.BaseManager

-- Configuration
local PRICE_MULTIPLIER = 1.2
local TRAVEL_SPEED = 20
local HOLD_DURATION = 1.5


-- Donn√©es des brainrots
local brainrotData = {}

-- Obtenir le prix de base
local function getBasePrice(brainrot)
	local basePrice = brainrot:GetAttribute("BasePrice")

	if not basePrice then
		warn("‚ö†Ô∏è Brainrot", brainrot.Name, "n'a pas d'attribut BasePrice ! Utilisation de 100 par d√©faut")
		return 100
	end

	return basePrice
end

-- Obtenir le prix actuel
local function getCurrentPrice(brainrot)
	local data = brainrotData[brainrot]
	if data then
		return tonumber(data.currentPrice) or 0
	else
		return tonumber(getBasePrice(brainrot)) or 0
	end
end

-- Formater un nombre
local function formatNumber(num)
	-- Convertir en nombre au cas o√π ce serait une string
	num = tonumber(num) or 0

	if num >= 1000000 then
		return string.format("%.1fM", num / 1000000)
	elseif num >= 1000 then
		return string.format("%.1fK", num / 1000)
	else
		return tostring(math.floor(num))
	end
end

-- Cr√©er le ProximityPrompt
local function createProximityPrompt(brainrot)
	local existingPrompt = brainrot.PrimaryPart:FindFirstChild("PurchasePrompt")
	if existingPrompt then
		return existingPrompt
	end

	local rarity = brainrot:GetAttribute("Rarity") or "Brainrot"
	local price = getCurrentPrice(brainrot)

	local prompt = Instance.new("ProximityPrompt")
	prompt.Name = "PurchasePrompt"
	prompt.ObjectText = rarity .. " - üíñ " .. formatNumber(price) .. " Rizz"
	prompt.ActionText = "Acheter"
	prompt.HoldDuration = HOLD_DURATION
	prompt.MaxActivationDistance = 15
	prompt.RequiresLineOfSight = false
	prompt.KeyboardKeyCode = Enum.KeyCode.E
	prompt.Style = Enum.ProximityPromptStyle.Default
	prompt.Parent = brainrot.PrimaryPart

	return prompt
end

-- Mettre √† jour le ProximityPrompt
local function updateProximityPrompt(brainrot)
	local prompt = brainrot.PrimaryPart:FindFirstChild("PurchasePrompt")
	if not prompt then return end

	local rarity = brainrot:GetAttribute("Rarity") or "Brainrot"
	local price = getCurrentPrice(brainrot)
	local isTraveling = brainrot:GetAttribute("Traveling")
	local ownerName = brainrot:GetAttribute("OwnerName")

	if isTraveling then
		prompt.ObjectText = rarity .. " - üíñ " .. formatNumber(price) .. " Rizz\nüîÑ ‚Üí " .. (ownerName or "???")
		prompt.ActionText = "Racheter (x1.2)"
	else
		prompt.ObjectText = rarity .. " - üíñ " .. formatNumber(price) .. " Rizz"
		prompt.ActionText = "Acheter"
	end
end

-- D√©placer vers la base
local function moveBrainrotToPlatform(brainrot, platform, owner)

	local data = brainrotData[brainrot]
	if not data then 
		warn("‚ùå Pas de data pour ce brainrot")
		return 
	end

	data.traveling = true
	data.targetPlatform = platform

	BaseManager.OccupyPlatform(platform, brainrot.Name)

	-- V√©rifier que le brainrot a un PrimaryPart
	if not brainrot.PrimaryPart then
		warn("‚ùå PAS DE PRIMARYPART !")
		return
	end

	-- MARQUER LE BRAINROT COMME POSS√âD√â IMM√âDIATEMENT
	brainrot:SetAttribute("Owner", owner.UserId)
	brainrot:SetAttribute("OwnerName", owner.Name)
	brainrot:SetAttribute("Traveling", true)

	task.wait(0.2) -- Laisser le temps au BrainSpawner de d√©tecter

	-- STOPPER TOUS LES MOUVEMENTS
	local stoppedCount = 0

	for _, desc in pairs(brainrot:GetDescendants()) do
		if desc:IsA("Tween") then
			pcall(function() 
				desc:Cancel() 
				desc:Destroy()
			end)
			stoppedCount = stoppedCount + 1
		end
		if desc.Name == "CF" or desc:IsA("CFrameValue") then
			pcall(function() desc:Destroy() end)
			stoppedCount = stoppedCount + 1
		end
		if desc:IsA("BodyPosition") or desc:IsA("BodyVelocity") or desc:IsA("BodyGyro") then
			pcall(function() desc:Destroy() end)
			stoppedCount = stoppedCount + 1
		end
	end


	-- Ancrer temporairement
	for _, part in pairs(brainrot:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Anchored = true
			part.CanCollide = false
		end
	end

	task.wait(0.3)

	-- Positions
	local startPos = brainrot.PrimaryPart.Position
	local targetPos = platform.Position + Vector3.new(0, 3, 0)
	local distance = (targetPos - startPos).Magnitude
	local travelTime = distance / TRAVEL_SPEED


	updateProximityPrompt(brainrot)

	-- D√âPLACEMENT PAR PETITS PAS AVEC RUNSERVICE
	local startTime = tick()
	local stepCount = 0
	local lastPercent = 0

	local moveConnection
	moveConnection = RunService.Heartbeat:Connect(function()
		stepCount = stepCount + 1

		-- V√©rifier que le brainrot existe toujours
		if not brainrot or not brainrot.Parent or not brainrot.PrimaryPart then
			if moveConnection then
				moveConnection:Disconnect()
			end
			return
		end

		local elapsed = tick() - startTime
		local progress = math.min(elapsed / travelTime, 1)

		-- Log tous les 25%
		local currentPercent = math.floor(progress * 4) * 25
		if currentPercent > lastPercent and currentPercent % 25 == 0 then
			lastPercent = currentPercent
		end

		-- Position interpol√©e
		local currentPos = startPos:Lerp(targetPos, progress)

		-- D√©placer le mod√®le
		local currentCFrame = brainrot.PrimaryPart.CFrame
		local newCFrame = CFrame.new(currentPos) * (currentCFrame - currentCFrame.Position)

		pcall(function()
			brainrot:SetPrimaryPartCFrame(newCFrame)
		end)

		-- Termin√© ?
		if progress >= 1 then

			if moveConnection then
				moveConnection:Disconnect()
				moveConnection = nil
			end

			-- V√©rifier le propri√©taire final
			local finalOwner = brainrot:GetAttribute("Owner")

			if finalOwner == owner.UserId then

				brainrot:SetAttribute("Traveling", false)
				brainrot:SetAttribute("AtBase", true)
				data.traveling = false

				-- Ancrer d√©finitivement
				for _, part in pairs(brainrot:GetDescendants()) do
					if part:IsA("BasePart") then
						part.Anchored = true
					end
				end

				-- SAUVEGARDER DANS LE DATAMANAGER
				if DataManager then

					local brainrotSaveData = {
						Type = brainrot:GetAttribute("Rarity"),
						SlotNumber = platform:GetAttribute("SlotNumber"),
						PriceMultiplier = data.priceMultiplier
					}

					
					DataManager.AddBrainrot(owner, brainrotSaveData)

					-- Forcer une sauvegarde imm√©diate dans le DataStore
					DataManager.SaveData(owner)

					-- V√©rifier que c'est bien sauvegard√©
					local savedBrainrots = DataManager.GetBrainrots(owner)
				else
					warn("‚ùå‚ùå‚ùå DATAMANAGER NON DISPONIBLE !")
				end

				-- D√©sactiver le prompt
				local prompt = brainrot.PrimaryPart:FindFirstChild("PurchasePrompt")
				if prompt then
					prompt.Enabled = false
				end

				-- D√©placer vers OwnedBrainrots folder
				local ownedFolder = workspace:FindFirstChild("OwnedBrainrots")
				if not ownedFolder then
					ownedFolder = Instance.new("Folder")
					ownedFolder.Name = "OwnedBrainrots"
					ownedFolder.Parent = workspace
				end
				brainrot.Parent = ownedFolder
			else
				-- Rachet√© pendant le trajet
				local newOwner = Players:GetPlayerByUserId(finalOwner)
				if newOwner then
					local newPlatform = BaseManager.GetFreePlatform(newOwner)
					if newPlatform then
						BaseManager.FreePlatform(platform)
						moveBrainrotToPlatform(brainrot, newPlatform, newOwner)
					else
						warn("‚ùå Nouveau propri√©taire n'a plus de place !")
					end
				end
			end
		end
	end)

end

-- G√©rer l'achat
local function purchaseBrainrot(player, brainrot)

	-- V√©rification 1 : Managers disponibles
	if not DataManager then
		warn("‚ùå √âCHEC: DataManager non disponible")
		return false
	end

	if not BaseManager then
		warn("‚ùå √âCHEC: BaseManager non disponible")
		return false
	end

	-- V√©rification 2 : Brainrot d√©j√† √† une base ?
	local atBase = brainrot:GetAttribute("AtBase")

	if atBase then
		warn("‚ùå √âCHEC: Brainrot d√©j√† install√© dans une base")
		return false
	end

	-- V√©rification 3 : Le joueur a une base ?
	local playerData = BaseManager.GetPlayerData(player)

	if not playerData then
		warn("‚ùå √âCHEC: Joueur n'a pas de base")
		warn("   ‚Üí Le joueur doit d'abord s√©lectionner une base !")
		return false
	end

	-- V√©rification 4 : Place disponible ?
	local freePlatform = BaseManager.GetFreePlatform(player)

	if not freePlatform then
		warn("‚ùå √âCHEC: Plus de place dans la base")
		warn("   ‚Üí Base pleine (14/14 platforms occup√©es)")
		return false
	end

	-- V√©rification 5 : Prix et Rizz
	local price = tonumber(getCurrentPrice(brainrot)) or 0
	local playerRizz = tonumber(DataManager.GetRizz(player)) or 0

	if playerRizz < price then
		warn("‚ùå √âCHEC: Pas assez de Rizz")
		warn("   N√©cessaire:", price, "/ Poss√©d√©:", playerRizz)
		return false
	end

	-- V√©rification 6 : D√©j√† propri√©taire ?
	local previousOwner = brainrot:GetAttribute("Owner")

	if previousOwner and previousOwner == player.UserId then
		warn("‚ùå √âCHEC: Joueur poss√®de d√©j√† ce brainrot")
		return false
	end


	-- Retirer le Rizz
	DataManager.RemoveRizz(player, price)

	-- Rembourser l'ancien propri√©taire si rachat
	if previousOwner then
		local previousPlayer = Players:GetPlayerByUserId(previousOwner)
		if previousPlayer then
			local data = brainrotData[brainrot]
			if data and data.previousPrice then
				DataManager.AddRizz(previousPlayer, data.previousPrice)
			end

			if data and data.targetPlatform then
				BaseManager.FreePlatform(data.targetPlatform)
			end
		end
	end

	-- Initialiser ou mettre √† jour les donn√©es du brainrot
	if not brainrotData[brainrot] then
		brainrotData[brainrot] = {
			owner = player,
			currentPrice = price,
			previousPrice = price,
			priceMultiplier = 1,
			traveling = false,
			targetPlatform = nil
		}
	else
		local data = brainrotData[brainrot]
		data.previousPrice = data.currentPrice
		data.currentPrice = math.floor(data.currentPrice * PRICE_MULTIPLIER)
		data.priceMultiplier = data.priceMultiplier * PRICE_MULTIPLIER
		data.owner = player

	end

	-- Mettre √† jour le prompt
	updateProximityPrompt(brainrot)

	-- D√©placer vers la base
	moveBrainrotToPlatform(brainrot, freePlatform, player)

	return true
end

-- √âcouter les ProximityPrompts
ProximityPromptService.PromptTriggered:Connect(function(prompt, player)


	if prompt.Name == "PurchasePrompt" then

		-- Le brainrot est le Parent du PrimaryPart qui contient le Prompt
		local primaryPart = prompt.Parent

		local brainrot = primaryPart and primaryPart.Parent

		if brainrot and brainrot:IsA("Model") then


			local success = purchaseBrainrot(player, brainrot)

			if success then
			else
				warn("‚ùå ACHAT √âCHOU√â")
			end
		else
			warn("   ‚ùå Brainrot invalide ou pas un Model")
			warn("   Type:", brainrot and brainrot.ClassName or "nil")
		end
	else
		print("   ‚ö†Ô∏è Pas un PurchasePrompt, ignor√©")
	end

end)


-- Setup des brainrots
local function setupBrainrots()
	local brainrotsFolder = workspace:FindFirstChild("BrainRot")
	if not brainrotsFolder then
		warn("‚ö†Ô∏è Folder 'BrainRot' introuvable")
		return
	end


	-- Fonction pour setup un brainrot
	local function setupBrainrot(brainrot)
		if not brainrot:IsA("Model") then
			return
		end


		-- V√©rifier/d√©finir le PrimaryPart
		if not brainrot.PrimaryPart then

			-- Chercher dans cet ordre de priorit√©
			local primaryPart = brainrot:FindFirstChild("RootPart") 
				or brainrot:FindFirstChild("FakeRootPart")
				or brainrot:FindFirstChild("Body")
				or brainrot:FindFirstChild("Head")
				or brainrot:FindFirstChild("Torso")
				or brainrot:FindFirstChildWhichIsA("BasePart", true)

			if primaryPart then
				brainrot.PrimaryPart = primaryPart
			else
				warn("   ‚ùå AUCUNE BASEPART TROUV√âE !")
				return
			end
		else
		end

		-- Cr√©er le ProximityPrompt
		local prompt = createProximityPrompt(brainrot)

		if prompt then
		else
			warn("   ‚ùå √âchec cr√©ation ProximityPrompt")
		end

	end

	-- Setup des brainrots existants
	for _, brainrot in pairs(brainrotsFolder:GetChildren()) do
		setupBrainrot(brainrot)
	end

	-- √âcouter les nouveaux brainrots
	brainrotsFolder.ChildAdded:Connect(function(brainrot)
		task.wait(0.2) -- Attendre que le brainrot soit compl√®tement charg√©
		setupBrainrot(brainrot)
	end)

end

task.wait(2)
setupBrainrots()
