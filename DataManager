-- ServerScriptService/DataManager
-- SystÃ¨me de sauvegarde des donnÃ©es des joueurs
-- CrÃ©Ã© le 2025-11-16 par Adeline-IRIHS

local Players = game:GetService("Players")
local DataStoreService = game:GetService("DataStoreService")

-- DataStore
local PlayerDataStore = DataStoreService:GetDataStore("PlayerData_v1") -- Change la version si tu veux reset les donnÃ©es

-- Structure de donnÃ©es par dÃ©faut
local DEFAULT_DATA = {
	Rizz = 0, -- Monnaie du joueur
	BaseNumber = nil, -- Quelle base il a choisi (1 Ã  8, nil = aucune)
	Brainrots = {}, -- Liste des brainrots achetÃ©s
	Floors = {1}, -- Ã‰tages dÃ©bloquÃ©s (commence avec Floor 1)
	LastSave = os.time()
}

-- DonnÃ©es des joueurs en mÃ©moire
local playerData = {}

-- Fonction pour charger les donnÃ©es d'un joueur
local function loadPlayerData(player)
	local userId = player.UserId
	local success, data = pcall(function()
		return PlayerDataStore:GetAsync("Player_" .. userId)
	end)

	if success then
		if data then
			-- DonnÃ©es trouvÃ©es, les charger
			playerData[userId] = data
			warn("âœ… DonnÃ©es chargÃ©es pour", player.Name, "- Rizz:", data.Rizz)
		else
			-- Nouveau joueur, crÃ©er des donnÃ©es par dÃ©faut
			playerData[userId] = {
				Rizz = DEFAULT_DATA.Rizz,
				BaseNumber = DEFAULT_DATA.BaseNumber,
				Brainrots = {},
				Floors = {1},
				LastSave = os.time()
			}
			warn("ğŸ†• Nouveau joueur:", player.Name, "- DonnÃ©es par dÃ©faut crÃ©Ã©es")
		end
	else
		-- Erreur de chargement
		warn("âŒ Erreur de chargement pour", player.Name, "- DonnÃ©es par dÃ©faut utilisÃ©es")
		playerData[userId] = {
			Rizz = DEFAULT_DATA.Rizz,
			BaseNumber = DEFAULT_DATA.BaseNumber,
			Brainrots = {},
			Floors = {1},
			LastSave = os.time()
		}
	end

	-- CrÃ©er les leaderstats (affichage dans la liste des joueurs)
	local leaderstats = Instance.new("Folder")
	leaderstats.Name = "leaderstats"
	leaderstats.Parent = player

	local rizzValue = Instance.new("IntValue")
	rizzValue.Name = "Rizz"
	rizzValue.Value = playerData[userId].Rizz
	rizzValue.Parent = leaderstats

	return playerData[userId]
end

-- Fonction pour sauvegarder les donnÃ©es d'un joueur
local function savePlayerData(player)
	local userId = player.UserId
	local data = playerData[userId]

	if not data then
		warn("âš ï¸ Aucune donnÃ©e Ã  sauvegarder pour", player.Name)
		return false
	end

	-- Mettre Ã  jour le timestamp
	data.LastSave = os.time()

	-- Sauvegarder
	local success, errorMessage = pcall(function()
		PlayerDataStore:SetAsync("Player_" .. userId, data)
	end)

	if success then
		warn("ğŸ’¾ DonnÃ©es sauvegardÃ©es pour", player.Name)
		return true
	else
		warn("âŒ Erreur de sauvegarde pour", player.Name, ":", errorMessage)
		return false
	end
end

-- Quand un joueur rejoint
Players.PlayerAdded:Connect(function(player)
	loadPlayerData(player)
end)

-- Quand un joueur quitte
Players.PlayerRemoving:Connect(function(player)
	savePlayerData(player)
	playerData[player.UserId] = nil
end)

-- Sauvegarde automatique toutes les 5 minutes
task.spawn(function()
	while true do
		task.wait(300) -- 5 minutes
		for _, player in pairs(Players:GetPlayers()) do
			savePlayerData(player)
		end
		warn("ğŸ”„ Sauvegarde automatique effectuÃ©e")
	end
end)

-- Sauvegarde avant fermeture du serveur
game:BindToClose(function()
	warn("ğŸ›‘ Serveur en cours de fermeture, sauvegarde de tous les joueurs...")
	for _, player in pairs(Players:GetPlayers()) do
		savePlayerData(player)
	end
	task.wait(3) -- Attendre que les sauvegardes se terminent
end)

-- Fonctions globales accessibles par d'autres scripts
_G.DataManager = {
	-- Obtenir les donnÃ©es d'un joueur
	GetData = function(player)
		return playerData[player.UserId]
	end,

	-- Obtenir le Rizz d'un joueur
	GetRizz = function(player)
		local data = playerData[player.UserId]
		return tonumber(data and data.Rizz or 0) or 0
	end,

	-- Ajouter du Rizz
	AddRizz = function(player, amount)
		local data = playerData[player.UserId]
		if data then
			data.Rizz = data.Rizz + amount

			-- Mettre Ã  jour les leaderstats
			local leaderstats = player:FindFirstChild("leaderstats")
			if leaderstats then
				local rizzValue = leaderstats:FindFirstChild("Rizz")
				if rizzValue then
					rizzValue.Value = data.Rizz
				end
			end

			return true
		end
		return false
	end,

	-- Retirer du Rizz
	RemoveRizz = function(player, amount)
		local data = playerData[player.UserId]
		if data and data.Rizz >= amount then
			data.Rizz = data.Rizz - amount

			-- Mettre Ã  jour les leaderstats
			local leaderstats = player:FindFirstChild("leaderstats")
			if leaderstats then
				local rizzValue = leaderstats:FindFirstChild("Rizz")
				if rizzValue then
					rizzValue.Value = data.Rizz
				end
			end

			return true
		end
		return false
	end,

	-- DÃ©finir la base du joueur
	SetBase = function(player, baseNumber)
		local data = playerData[player.UserId]
		if data then
			data.BaseNumber = baseNumber
			return true
		end
		return false
	end,

	-- Obtenir la base du joueur
	GetBase = function(player)
		local data = playerData[player.UserId]
		return data and data.BaseNumber or nil
	end,

	-- Ajouter un brainrot
	AddBrainrot = function(player, brainrotData)
		local data = playerData[player.UserId]
		if data then
			table.insert(data.Brainrots, brainrotData)
			return true
		end
		return false
	end,

	-- Obtenir tous les brainrots
	GetBrainrots = function(player)
		local data = playerData[player.UserId]
		return data and data.Brainrots or {}
	end,

	-- DÃ©bloquer un Ã©tage
	UnlockFloor = function(player, floorNumber)
		local data = playerData[player.UserId]
		if data then
			if not table.find(data.Floors, floorNumber) then
				table.insert(data.Floors, floorNumber)
				table.sort(data.Floors)
				return true
			end
		end
		return false
	end,

	-- Obtenir les Ã©tages dÃ©bloquÃ©s
	GetFloors = function(player)
		local data = playerData[player.UserId]
		return data and data.Floors or {1}
	end,

	-- Sauvegarder manuellement
	SaveData = function(player)
		return savePlayerData(player)
	end
}

warn("ğŸ’¾ DataManager initialisÃ© - PrÃªt Ã  sauvegarder les donnÃ©es !")
